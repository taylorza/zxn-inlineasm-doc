#program asmbasprof   5 RUN AT 3  10 SAVE "c:/asmbasprof.bas"  30 .asm1000 ;;Example NextZXOS driver1010 ;;by Simon N Godwin 5-20211020 ;;to be built natively :-)1030 ;;1031 ;      OUTPUT "C:/ASMBASPROF.DRV"1032 ;      DB "NDRV"1033 ;      DB "%"+1281034 ;      DB RELOCCNT1035 ;      DB 01036 ;      DB BANKS1039 ;1040 ;      ORG 0      ;Relocate base1050 ;APAGE EQU 8192 ;Page size1060 ;;Bank 6 base address for1070 ;;code and line number data1080 ;PAGE6 EQU 491521090 ;;DISP PAGE6 ;Object address1100 ;PPC   EQU 23621 ;Sys Var1105 ;ERRNR EQU 23610 ;Sys Var1110 ;BANKS EQU 3  ;20K needed1120 ;LIMIT EQU 512 ;Driver size1130 ;;ENT1140 ;;Entry point for commands1150 ;API   JR  COMMS1160 ;      NOP ;Offset 3 pad1170 ;;Entry point for interrupt1180 ;INTR  JR PROFI1190 ;;1200 ;COMMS LD  A,B ;DRIVER B,1210 ;      OR  A1220 ;      JR  NZ,NOT01230 ;      OR  D ;DRIVER 0,0?1240 ;      OR  E1250 ;      JR  Z,RESET ;0,01260 ;;DRIVER 0,Line Zero count1270 ;;Check that DE <= 99991280 ;      LD  HL,9999 ;Cy=01290 ;      SBC HL,DE1300 ;      JR  C,FAIL1310 ;R0    CALL PAGER1320 ;R1    CALL FINDL1325 ;      PUSH BC1330 ;      LD  C,(HL)1340 ;      XOR A ; Clear count1350 ;      LD (HL),A1360 ;      INC HL ;For HiByte1370 ;      LD  B,(HL)1380 ;      LD (HL),A1383 ;      LD  L,C1385 ;      LD  H,B1387 ;      POP BC1390 ;      JR  DONE ;OK, Cy=01400 ;;1410 ;;DRIVER 1,Line TO Count1420 ;NOT0  DJNZ NOT11422 ;      LD  A,D1424 ;      OR  E1427 ;      JR  Z,FAIL ;Line 0!1430 ;      LD  HL,99991440 ;      SBC HL,DE1450 ;      JR  C,FAIL ;DE>99991460 ;R2    CALL PAGER1470 ;R3    CALL FINDL1480 ;      LD  A,(HL) ;Count1490 ;      INC HL ;For HiByte1500 ;      LD  H,(HL)1505 ;      LD  L,A1510 ;      JR  DONE ;OK, Cy=01520 ;NOT1  DJNZ NOT21530 ;      OR  A     ;Clear Cy1540 ;R4    LD  HL,LIMIT-11550 ;      DEC DE ;Start at 11560 ;      SBC HL,DE ;Cy=error1570 ;      LD  C,(HL)1580 ;      RET ;Success if Cy=01590 ;NOT2  DJNZ FAIL1600 ;;Could add command 3 here1620 ;;1630 ;;Unmatched B, flag error1640 ;FAIL  XOR A1650 ;      SCF ;Cy=1, Error1660 ;      RET1670 ;;1680 ;;Clear all counts1690 ;RESET CALL PAGER1700 ;R5    LD  HL,LIMIT-11710 ;      PUSH DE ;Old state1720 ;      PUSH BC ;DATA reg1730 ;      LD  B,BANKS1740 ;BLOOP LD  A,(HL)1743 ;;Use NEXTREG 86,A opcode1746 ;;to map bank A to PAGE61750 ;      NEXTREG 86,A1760 ;      XOR A1770 ;      PUSH HL1780 ;      PUSH BC1790 ;      LD DE,PAGE6+1 ;Dest1800 ;      LD HL,PAGE6 ;Source1810 ;      LD  (HL),A ;Clear 11820 ;      LD  BC,APAGE-11830 ;      LDIR   ; Clear page1840 ;      POP BC1850 ;      POP HL1860 ;      DEC HL1870 ;      DJNZ BLOOP1880 ;      POP BC  ;Port addr1890 ;      POP DE  ;Port state1900 ;      JR  DONE1910 ;;1920 ;;BASIC Profile handler1930 ;PROFI LD  A,(ERRNR)1934 ;      INC A ;255=Running1936 ;      JR  NZ,LINE0 ;Stop1938 ;      LD  DE,(PPC) ;Line1940 ;      LD  A,D1950 ;      OR  E1960 ;      JR  Z,LINE01970 ;R6    CALL PAGER1980 ;R7    CALL FINDL2090 ;      INC (HL) ;Low byte2100 ;      JR  NZ,DONE2110 ;;Carry to high byte2120 ;      INC HL2130 ;      INC (HL)2140 ;      JR  NC,DONE2150 ;;OVERFLOW! Clamp to 655352160 ;      DEC (HL)2170 ;      DEC HL2180 ;      DEC (HL)2190 ;;Restore banks and return2200 ;;D=Old SELECT register2210 ;;E=Old slot 6 bank BC=DATA2220 ;DONE  LD  A,E ;Reset bank2230 ;      NEXTREG 86,A2240 ;;Restore select2250 ;      DEC B2260 ;      OUT (C),D2263 ;      LD B,H2265 ;      LD C,L2270 ;LINE0 RET2280 ;;2300 ;;Find slot for linenum HL2310 ;FINDL LD  A,15 ;Line HL2320 ;      AND H2325 ;      PUSH DE2330 ;;Save address bits 8..112340 ;      LD  D,A2350 ;;Get bank # 0..2 into A2360 ;      LD  A,%001100002370 ;      AND H ;Bits 12 & 132380 ;      RRCA ;Divide by 162390 ;      RRCA2400 ;      RRCA ;to bits 0 & 12410 ;      RRCA2420 ;;Restore HL (LNUM & 4095)2430 ;      LD  H,D ;HL 0..40952440 ;      ADD HL,HL ; 0..81902450 ;;Offset to bank base2460 ;      LD  DE,PAGE6 ;8K*62470 ;      ADD HL,DE2490 ;;Bank numbers at 509..5112500 ;      EX  DE,HL2510 ;R8    LD  HL,HIGHSTREET2520 ;      ADD A,L ;L=253..2552530 ;;Save current SELECT port2540 ;      LD  L,A ;HL->Bank #2550 ;      LD  A,(HL) ;A=Bank2560 ;      EX  DE,HL2570 ;      POP DE2580 ;;Use NEXTREG 86,A opcode2590 ;      NEXTREG 86,A2600 ;;Bank is now at 491522800 ;      RET       ;HL->slot2810 ;;2820 ;;Find bank configuration2830 ;PAGER EX  DE,HL ;So HL=DE2840 ;      LD  BC,9275 ;Select2850 ;      IN  D,(C)2860 ;      LD  E,862870 ;      OUT (C),E ;Get MMU62880 ;      INC B2890 ;      IN  E,(C) ;IN 95312900 ;COUNT RET2910 ;;2920 ;;Variables and constants2930 ;      DS LIMIT-$-BANKS ; Bank #s2940 ;HIGHSTREET DB 0,0,02950 ;;2960 ;;High bytes of addresses2970 ;RELOCS EQU $ ;512 (LIMIT)2980 ;      DW R0+22990 ;      DW R1+23000 ;      DW R2+23010 ;      DW R3+23020 ;      DW R4+23030 ;      DW R5+23040 ;      DW R6+23050 ;      DW R7+23060 ;      DW R8+23070 ;      DW RESET+23080 ;RELOCCNT EQU $-RELOCS/23090 ;      DB 1 3100 ;      DW 0     3110 ;      DW HIGHSTREET3120 ;      DB 1 3130 ;      DW 0     3140 ;      DW HIGHSTREET+13150 ;      DB 1 3160 ;      DW 0     3170 ;      DW HIGHSTREET+2